<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Key Management</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --text-dark: #424242;
            --text-light: #757575;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 25%, #48dbfb 50%, #1dd1a1 75%, #ee5a6f 100%); 
            min-height: 100vh; 
            animation: rainbowShift 15s ease infinite; 
            background-size: 200% 200%;
            position: relative;
        }
        @keyframes rainbowShift { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        body::before { 
            content: ''; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-image: linear-gradient(30deg, rgba(255,255,255,.1) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.1) 87.5%, rgba(255,255,255,.1)), linear-gradient(150deg, rgba(255,255,255,.1) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,.1) 87.5%, rgba(255,255,255,.1)); 
            background-size: 80px 140px; 
            opacity: 0.3; 
            pointer-events: none; 
        }
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; position: relative; z-index: 1; }
        .page { 
            background: white; 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.15); 
            border-top: 4px solid transparent;
            border-image: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1, #ee5a6f) 1;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .page-header { 
            text-align: center; 
            margin-bottom: 30px; 
            padding-bottom: 20px;
            border-bottom: 2px solid transparent;
            border-image: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1, #ee5a6f) 1;
        }
        h1 { 
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1, #ee5a6f); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
            font-size: 2rem; 
            margin-bottom: 5px; 
        }
        .page-subtitle { color: var(--text-light); }
        .logout-btn { 
            float: right; 
            margin-top: -30px; 
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f); 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            box-shadow: 0 4px 12px rgba(255,107,107,0.3);
            transition: all 0.3s;
        }
        .logout-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255,107,107,0.5);
        }
        
        /* Stats Cards */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { 
            background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(254,202,87,0.1), rgba(72,219,251,0.1)); 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            border: 2px solid transparent;
            border-image: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb) 1;
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(72,219,251,0.3);
        }
        .stat-card.warning { 
            background: linear-gradient(135deg, rgba(254,202,87,0.15), rgba(255,183,77,0.1)); 
            border-image: linear-gradient(135deg, #feca57, #ff9800) 1;
        }
        .stat-card.danger { 
            background: linear-gradient(135deg, rgba(255,107,107,0.15), rgba(238,90,111,0.1)); 
            border-image: linear-gradient(135deg, #ff6b6b, #ee5a6f) 1;
        }
        .stat-value { 
            font-size: 2rem; 
            font-weight: 700; 
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }
        .stat-card.warning .stat-value { 
            background: linear-gradient(90deg, #feca57, #ff9800); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }
        .stat-card.danger .stat-value { 
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
        }
        .stat-label { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; }

        /* Table */
        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            border-radius: 8px; 
            overflow: hidden; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); 
        }
        thead { 
            background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1); 
            color: white; 
        }
        th, td { padding: 12px 14px; text-align: left; font-size: 0.85rem; }
        th { font-weight: 600; text-transform: uppercase; }
        tbody tr { background: white; transition: all 0.3s; }
        tbody tr:nth-child(even) { background: #fdfdfd; }
        tbody tr:hover { 
            background: linear-gradient(135deg, rgba(255,107,107,0.05), rgba(254,202,87,0.05), rgba(72,219,251,0.05)); 
        }
        .api-key-text { 
            font-family: monospace; 
            font-size: 0.8rem; 
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #1dd1a1); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
            max-width: 180px; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            font-weight: 600;
        }

        /* Status Badges */
        .status { display: inline-block; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status.aktif { 
            background: linear-gradient(135deg, rgba(29,209,161,0.2), rgba(72,219,251,0.2)); 
            color: #1dd1a1; 
            border: 1px solid #1dd1a1; 
        }
        .status.nonaktif { 
            background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(238,90,111,0.2)); 
            color: #ff6b6b; 
            border: 1px solid #ff6b6b; 
        }

        /* Last Login Status */
        .login-info { display: flex; flex-direction: column; gap: 2px; }
        .login-date { font-size: 0.8rem; color: var(--text-dark); }
        .login-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 2px; font-weight: 600; }
        .login-badge.ok { background: rgba(29,209,161,0.2); color: #1dd1a1; border: 1px solid #1dd1a1; }
        .login-badge.warning { background: rgba(254,202,87,0.2); color: #feca57; border: 1px solid #feca57; }
        .login-badge.expired { background: rgba(255,107,107,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; }
        .login-badge.never { background: #f5f5f5; color: var(--text-light); border: 1px solid #ddd; }

        /* Action Buttons */
        td.action-cell { display: flex; flex-direction: column; gap: 5px; }
        .action-btn { 
            padding: 6px 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 600; 
            width: 80px; 
            text-align: center; 
            transition: all 0.3s;
        }
        .btn-delete { 
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f); 
            color: white; 
            box-shadow: 0 3px 10px rgba(255,107,107,0.3);
        }
        .btn-delete:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255,107,107,0.5);
        }
        .btn-toggle { 
            background: #f1f1f1; 
            color: var(--text-dark); 
            border: 1px solid #ccc; 
        }
        .btn-toggle:hover { background: #e0e0e0; }
        .btn-toggle.enable { 
            background: linear-gradient(135deg, #1dd1a1, #48dbfb); 
            color: white; 
            border: none; 
            box-shadow: 0 3px 10px rgba(29,209,161,0.3);
        }
        .btn-toggle.enable:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(29,209,161,0.5);
        }

        /* Message */
        .message { 
            padding: 12px 18px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            display: none; 
            border-left: 4px solid; 
            animation: slideDown 0.4s ease-out;
        }
        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .message.success { 
            background: #e8f5e9; 
            color: #1dd1a1; 
            border-color: #1dd1a1; 
            display: block; 
        }
        .message.error { 
            background: #ffebee; 
            color: #ff6b6b; 
            border-color: #ff6b6b; 
            display: block; 
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9e9e9e;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }
        .back-link a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(254,202,87,0.1), rgba(72,219,251,0.1));
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s;
            border: 2px solid transparent;
            background: linear-gradient(90deg, #ff6b6b, #48dbfb); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text;
            font-weight: 600;
        }
        .back-link a:hover {
            border-color: #48dbfb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72,219,251,0.2);
        }

        @media (max-width: 1200px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { 
            .stats-row { grid-template-columns: 1fr; } 
            th, td { padding: 8px 6px; font-size: 0.75rem; }
            .page { padding: 25px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="logout-btn" onclick="logout()">Logout</button>
        <div class="message" id="adminMessage"></div>
        <div class="page">
            <div class="page-header">
                <h1>üåà Admin Dashboard</h1>
                <p class="page-subtitle">Manage users and API keys</p>
            </div>
            <div class="stats-row" id="statsRow">
                <div class="stat-card"><div class="stat-value" id="totalUsers">0</div><div class="stat-label">Total Users</div></div>
                <div class="stat-card"><div class="stat-value" id="activeUsers">0</div><div class="stat-label">Active</div></div>
                <div class="stat-card warning"><div class="stat-value" id="warningUsers">0</div><div class="stat-label">Warning (25+ days)</div></div>
                <div class="stat-card danger"><div class="stat-value" id="inactiveUsers">0</div><div class="stat-label">Inactive</div></div>
            </div>
            <div id="tableContainer"><div class="loading">Loading data...</div></div>
            <div class="back-link">
                <a href="index.html">‚Üê Back to Home</a>
            </div>
        </div>
    </div>
    <script>
        let adminToken = localStorage.getItem('adminToken');
        if (!adminToken) window.location.href = 'admin-login.html';

        function showMessage(message, type) {
            const msgEl = document.getElementById('adminMessage');
            msgEl.textContent = message;
            msgEl.className = `message ${type}`;
            msgEl.style.display = 'block';
            setTimeout(() => { msgEl.style.display = 'none'; }, 3000);
        }

        async function loadUsers() {
            try {
                const response = await fetch('/admin/users', { headers: { 'Authorization': 'Bearer ' + adminToken } });
                if (response.status === 401) { localStorage.removeItem('adminToken'); window.location.href = 'admin-login.html'; return; }
                const data = await response.json();
                if (data.success && data.users.length > 0) {
                    displayUsers(data.users);
                    updateStats(data.users);
                } else {
                    document.getElementById('tableContainer').innerHTML = '<p style="text-align:center;padding:50px;color:#9e9e9e;">No registered users yet</p>';
                }
            } catch (error) {
                document.getElementById('tableContainer').innerHTML = '<p style="text-align:center;padding:50px;color:#ff6b6b;">Error: ' + error.message + '</p>';
            }
        }

        function updateStats(users) {
            const total = users.length;
            const active = users.filter(u => u.is_active === 1 && u.login_status === 'ok').length;
            const warning = users.filter(u => u.login_status === 'warning').length;
            const inactive = users.filter(u => u.is_active === 0 || u.login_status === 'expired' || u.login_status === 'inactive').length;
            document.getElementById('totalUsers').textContent = total;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('warningUsers').textContent = warning;
            document.getElementById('inactiveUsers').textContent = inactive;
        }

        function getLoginBadge(user) {
            if (user.is_active === 0) return `<span class="login-badge expired">Deactivated</span>`;
            if (user.last_login_formatted === 'Never') return `<span class="login-badge never">Never logged in</span>`;
            
            const days = user.days_until_inactive;
            if (days <= 0) return `<span class="login-badge expired">Expired</span>`;
            if (days <= 5) return `<span class="login-badge warning">${days} days left</span>`;
            return `<span class="login-badge ok">${days} days left</span>`;
        }

        function displayUsers(users) {
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>First</th>
                            <th>Last</th>
                            <th>Email</th>
                            <th>API Key</th>
                            <th>Last Login</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const isActive = user.is_active === 1;
                            const statusClass = isActive ? 'aktif' : 'nonaktif';
                            const statusText = isActive ? 'ACTIVE' : 'INACTIVE';
                            const toggleText = isActive ? 'Disable' : 'Enable';
                            const toggleClass = isActive ? '' : 'enable';
                            
                            return `
                                <tr id="user-${user.id}">
                                    <td>${user.id}</td>
                                    <td>${user.nama_depan}</td>
                                    <td>${user.nama_belakang}</td>
                                    <td>${user.email}</td>
                                    <td class="api-key-text" title="${user.api_key}">${user.api_key.substring(0, 25)}...</td>
                                    <td>
                                        <div class="login-info">
                                            <span class="login-date">${user.last_login_formatted}</span>
                                            ${getLoginBadge(user)}
                                        </div>
                                    </td>
                                    <td><span class="status ${statusClass}">${statusText}</span></td>
                                    <td class="action-cell">
                                        <button class="action-btn btn-delete" onclick="deleteUser(${user.id})">Delete</button>
                                        <button class="action-btn btn-toggle ${toggleClass}" onclick="toggleStatus(${user.id})">${toggleText}</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        async function toggleStatus(userId) {
            if (!confirm('Toggle status API Key user ini?')) return;
            try {
                const response = await fetch(`/admin/users/${userId}/toggle`, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + adminToken, 'Content-Type': 'application/json' }
                });
                if (response.status === 401) { localStorage.removeItem('adminToken'); window.location.href = 'admin-login.html'; return; }
                const data = await response.json();
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadUsers();
                } else {
                    showMessage('Gagal: ' + data.message, 'error');
                }
            } catch (error) { showMessage('Error: ' + error.message, 'error'); }
        }

        async function deleteUser(userId) {
            if (!confirm('Hapus user ini?')) return;
            try {
                const response = await fetch(`/admin/users/${userId}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + adminToken } });
                const data = await response.json();
                if (data.success) { showMessage('User berhasil dihapus!', 'success'); loadUsers(); }
                else { showMessage('Gagal: ' + data.message, 'error'); }
            } catch (error) { showMessage('Error: ' + error.message, 'error'); }
        }

        function logout() {
            if (confirm('Logout?')) { localStorage.removeItem('adminToken'); window.location.href = 'admin-login.html'; }
        }

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>